<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejemplo Simple - Integración Chat Iframe</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: #2563eb;
        color: white;
        padding: 20px;
        text-align: center;
      }

      .content {
        padding: 20px;
      }

      .chat-container {
        height: 500px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin: 20px 0;
      }

      .chat-iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 8px;
      }

      .code-example {
        background: #1f2937;
        color: #f9fafb;
        padding: 20px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        margin: 20px 0;
        overflow-x: auto;
      }

      .btn {
        background: #2563eb;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
      }

      .btn:hover {
        background: #1d4ed8;
      }

      .status {
        background: #f3f4f6;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Ejemplo Simple - Integración Chat Iframe</h1>
        <p>Demostración básica de cómo integrar el chat en tu aplicación</p>
      </div>

      <div class="content">
        <h2>Paso 1: Crear el iframe</h2>
        <div class="code-example">
          &lt;iframe id="chat-iframe" src="https://ai-chatbot-n8n.vercel.app/"
          width="100%" height="500px" frameborder="0" &gt;&lt;/iframe&gt;
        </div>

        <h2>Paso 2: Enviar datos al chat</h2>
        <div class="code-example">
          // Datos que se envían al chat const userData = { CliCod: 20115, //
          Código del cliente PrdCod: 4, // Código del producto Email:
          "ihernandez@comercializadora-s3.com", userName: "Usuario" }; // Enviar
          datos al iframe
          document.getElementById('chat-iframe').contentWindow.postMessage({
          type: 'INIT_DATA', data: userData }, '*');
        </div>

        <h2>Paso 3: Escuchar mensajes del chat</h2>
        <div class="code-example">
          // Escuchar mensajes del iframe window.addEventListener('message',
          function(event) { const message = event.data; switch (message.type) {
          case 'SESSION_STARTED': console.log('Chat iniciado:', message.data);
          break; case 'MESSAGE_SENT': console.log('Mensaje enviado:',
          message.data); break; case 'RESPONSE_RECEIVED': console.log('Respuesta
          recibida:', message.data); break; } });
        </div>

        <h2>Demo en vivo:</h2>
        <div class="status" id="status">
          Estado: Esperando que el iframe se cargue...
        </div>

        <button class="btn" onclick="sendDataToChat()">
          Enviar Datos al Chat
        </button>

        <button class="btn" onclick="resetChat()">Resetear Chat</button>

        <div class="chat-container">
          <iframe
            id="chat-iframe"
            class="chat-iframe"
            src="https://ai-chatbot-n8n.vercel.app/"
            title="Chat IA"
          ></iframe>
        </div>
      </div>
    </div>

    <script>
      let chatIframe = null;
      let isIframeReady = false;

      // Datos fijos para la demostración
      const userData = {
        CliCod: 20115,
        PrdCod: 4,
        Email: "ihernandez@comercializadora-s3.com",
        userName: "Usuario",
      };

      // Función para enviar datos al chat
      function sendDataToChat() {
        if (!isIframeReady) {
          alert("El iframe no está listo. Espera un momento.");
          return;
        }

        chatIframe.contentWindow.postMessage(
          {
            type: "INIT_DATA",
            data: userData,
          },
          "*"
        );

        document.getElementById("status").textContent =
          "Estado: Datos enviados - Cliente: " +
          userData.CliCod +
          ", Producto: " +
          userData.PrdCod;
      }

      // Función para resetear el chat
      function resetChat() {
        if (isIframeReady) {
          chatIframe.contentWindow.postMessage(
            {
              type: "RESET_SESSION",
            },
            "*"
          );

          document.getElementById("status").textContent =
            "Estado: Chat reseteado";
        }
      }

      // Escuchar mensajes del iframe
      window.addEventListener("message", function (event) {
        // Verificar que el mensaje viene del iframe
        if (event.source !== chatIframe?.contentWindow) {
          return;
        }

        const message = event.data;
        console.log("Mensaje recibido del chat:", message);

        switch (message.type) {
          case "SESSION_STARTED":
            if (message.data?.ready) {
              document.getElementById("status").textContent =
                "Estado: Chat listo para recibir datos";
            } else if (message.data?.received) {
              document.getElementById("status").textContent =
                "Estado: Datos recibidos por el chat";
            } else {
              document.getElementById("status").textContent =
                "Estado: Sesión activa - " + message.data?.sessionId;
            }
            break;

          case "MESSAGE_SENT":
            console.log(
              "Usuario envió mensaje de",
              message.data?.messageLength,
              "caracteres"
            );
            break;

          case "RESPONSE_RECEIVED":
            console.log("Agente respondió:", message.data);
            break;

          case "ERROR":
            console.error("Error en el chat:", message.data?.error);
            document.getElementById("status").textContent =
              "Estado: Error en el chat";
            break;
        }
      });

      // Inicializar cuando el DOM esté listo
      document.addEventListener("DOMContentLoaded", function () {
        chatIframe = document.getElementById("chat-iframe");

        // Esperar a que el iframe esté listo
        chatIframe.addEventListener("load", function () {
          isIframeReady = true;
          document.getElementById("status").textContent =
            'Estado: Iframe listo - Haz clic en "Enviar Datos al Chat"';

          // Enviar datos automáticamente después de 2 segundos
          setTimeout(() => {
            sendDataToChat();
          }, 2000);
        });
      });
    </script>
  </body>
</html>
