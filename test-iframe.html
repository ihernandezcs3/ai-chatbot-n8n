<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test - Integración Chat Iframe</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: #2563eb;
        color: white;
        padding: 20px;
        text-align: center;
      }

      .controls {
        padding: 20px;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
      }

      .control-group {
        margin-bottom: 15px;
      }

      .control-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #374151;
      }

      .control-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        box-sizing: border-box;
      }

      .buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
      }

      .btn-primary {
        background: #2563eb;
        color: white;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-secondary {
        background: #6b7280;
        color: white;
      }

      .btn-secondary:hover {
        background: #4b5563;
      }

      .btn-success {
        background: #059669;
        color: white;
      }

      .btn-success:hover {
        background: #047857;
      }

      .btn-danger {
        background: #dc2626;
        color: white;
      }

      .btn-danger:hover {
        background: #b91c1c;
      }

      .chat-container {
        height: 600px;
        position: relative;
      }

      .chat-iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .status {
        padding: 10px;
        background: #f3f4f6;
        border-top: 1px solid #e5e7eb;
        font-size: 14px;
        color: #6b7280;
      }

      .log {
        background: #1f2937;
        color: #f9fafb;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        border-top: 1px solid #374151;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }

      .log-info {
        color: #60a5fa;
      }
      .log-success {
        color: #34d399;
      }
      .log-error {
        color: #f87171;
      }
      .log-warning {
        color: #fbbf24;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Test - Integración Chat Iframe</h1>
        <p>Simula la aplicación padre (Siaffe) enviando datos al chat</p>
      </div>

      <div class="controls">
        <div class="control-group">
          <label for="cliCod">Código de Cliente (CliCod):</label>
          <input type="number" id="cliCod" value="20115" placeholder="20115" />
        </div>

        <div class="control-group">
          <label for="prdCod">Código de Producto (PrdCod):</label>
          <input type="number" id="prdCod" value="4" placeholder="4" />
        </div>

        <div class="control-group">
          <label for="email">Email:</label>
          <input
            type="email"
            id="email"
            value="ihernandez@comercializadora-s3.com"
            placeholder="ihernandez@comercializadora-s3.com"
          />
        </div>

        <div class="control-group">
          <label for="userName">Nombre de Usuario (opcional):</label>
          <input
            type="text"
            id="userName"
            value="Usuario"
            placeholder="Usuario"
          />
        </div>

        <div class="buttons">
          <button class="btn btn-primary" onclick="sendDataToChat()">
            Enviar Datos al Chat
          </button>
          <button class="btn btn-secondary" onclick="updateChatData()">
            Actualizar Datos
          </button>
          <button class="btn btn-success" onclick="sendTestData()">
            Datos de Prueba
          </button>
          <button class="btn btn-danger" onclick="resetChatSession()">
            Resetear Sesión
          </button>
          <button class="btn btn-secondary" onclick="clearLog()">
            Limpiar Log
          </button>
        </div>
      </div>

      <div class="chat-container">
        <iframe
          id="chat-iframe"
          class="chat-iframe"
          src="https://ai-chatbot-n8n.vercel.app/"
          title="Chat IA"
        ></iframe>
      </div>

      <div class="status" id="status">
        Estado: Esperando que el iframe se cargue...
      </div>

      <div class="log" id="log">
        <div class="log-entry log-info">
          Sistema iniciado. Esperando conexión con el iframe...
        </div>
      </div>
    </div>

    <script>
      // Variables globales
      let chatIframe = null;
      let isIframeReady = false;

      // Elementos del DOM
      const statusElement = document.getElementById("status");
      const logElement = document.getElementById("log");

      // Función para agregar entradas al log
      function addLogEntry(message, type = "info") {
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logElement.appendChild(entry);
        logElement.scrollTop = logElement.scrollHeight;
      }

      // Función para limpiar el log
      function clearLog() {
        logElement.innerHTML =
          '<div class="log-entry log-info">Log limpiado</div>';
      }

      // Función para obtener los datos del formulario
      function getFormData() {
        return {
          CliCod: parseInt(document.getElementById("cliCod").value) || 20115,
          PrdCod: parseInt(document.getElementById("prdCod").value) || 4,
          Email:
            document.getElementById("email").value ||
            "ihernandez@comercializadora-s3.com",
          userName: document.getElementById("userName").value || "Usuario",
        };
      }

      // Función para enviar datos al chat
      function sendDataToChat() {
        if (!isIframeReady) {
          addLogEntry("Error: El iframe no está listo", "error");
          return;
        }

        const data = getFormData();

        chatIframe.contentWindow.postMessage(
          {
            type: "INIT_DATA",
            data: data,
          },
          "*"
        );

        addLogEntry(
          `Datos enviados al chat: ${JSON.stringify(data)}`,
          "success"
        );
        statusElement.textContent = `Estado: Datos enviados - Cliente: ${data.CliCod}, Producto: ${data.PrdCod}`;
      }

      // Función para actualizar datos
      function updateChatData() {
        if (!isIframeReady) {
          addLogEntry("Error: El iframe no está listo", "error");
          return;
        }

        const data = getFormData();

        chatIframe.contentWindow.postMessage(
          {
            type: "UPDATE_DATA",
            data: data,
          },
          "*"
        );

        addLogEntry(`Datos actualizados: ${JSON.stringify(data)}`, "info");
      }

      // Función para enviar datos de prueba
      function sendTestData() {
        const testData = {
          CliCod: 99999,
          PrdCod: 1,
          Email: "test@ejemplo.com",
          userName: "Usuario de Prueba",
        };

        // Actualizar formulario
        document.getElementById("cliCod").value = testData.CliCod;
        document.getElementById("prdCod").value = testData.PrdCod;
        document.getElementById("email").value = testData.Email;
        document.getElementById("userName").value = testData.userName;

        if (isIframeReady) {
          chatIframe.contentWindow.postMessage(
            {
              type: "INIT_DATA",
              data: testData,
            },
            "*"
          );

          addLogEntry(
            `Datos de prueba enviados: ${JSON.stringify(testData)}`,
            "success"
          );
          statusElement.textContent = `Estado: Datos de prueba enviados`;
        } else {
          addLogEntry("Error: El iframe no está listo", "error");
        }
      }

      // Función para resetear la sesión
      function resetChatSession() {
        if (!isIframeReady) {
          addLogEntry("Error: El iframe no está listo", "error");
          return;
        }

        chatIframe.contentWindow.postMessage(
          {
            type: "RESET_SESSION",
          },
          "*"
        );

        addLogEntry("Sesión reseteada", "warning");
        statusElement.textContent = "Estado: Sesión reseteada";
      }

      // Manejar mensajes del iframe
      window.addEventListener("message", function (event) {
        // Verificar origen del mensaje
        if (event.source !== chatIframe?.contentWindow) {
          return;
        }

        const message = event.data;
        addLogEntry(`Mensaje recibido del chat: ${message.type}`, "info");

        switch (message.type) {
          case "SESSION_STARTED":
            if (message.data?.ready) {
              addLogEntry("Chat listo para recibir datos", "success");
              statusElement.textContent = "Estado: Chat listo";
            } else if (message.data?.received) {
              addLogEntry("Datos recibidos por el chat", "success");
              statusElement.textContent = "Estado: Datos recibidos por el chat";
            } else {
              addLogEntry(
                `Sesión iniciada: ${message.data?.sessionId}`,
                "success"
              );
              statusElement.textContent = `Estado: Sesión activa - ${message.data?.sessionId}`;
            }
            break;

          case "MESSAGE_SENT":
            addLogEntry(
              `Mensaje enviado por usuario (${message.data?.messageLength} caracteres)`,
              "info"
            );
            break;

          case "RESPONSE_RECEIVED":
            addLogEntry(
              `Respuesta recibida del agente (${message.data?.responseLength} caracteres)`,
              "success"
            );
            break;

          case "ERROR":
            addLogEntry(`Error en el chat: ${message.data?.error}`, "error");
            statusElement.textContent = "Estado: Error en el chat";
            break;

          default:
            addLogEntry(
              `Mensaje no reconocido: ${JSON.stringify(message)}`,
              "warning"
            );
        }
      });

      // Inicializar cuando el DOM esté listo
      document.addEventListener("DOMContentLoaded", function () {
        chatIframe = document.getElementById("chat-iframe");

        // Esperar a que el iframe esté listo
        chatIframe.addEventListener("load", function () {
          isIframeReady = true;
          addLogEntry("Iframe cargado y listo", "success");
          statusElement.textContent =
            "Estado: Iframe listo - Puedes enviar datos";

          // Enviar datos de prueba automáticamente después de un delay
          setTimeout(() => {
            sendTestData();
          }, 2000);
        });

        addLogEntry(
          "Sistema inicializado. Esperando carga del iframe...",
          "info"
        );
      });
    </script>
  </body>
</html>
